# go-apt-proxy

## Обзор

go-apt-proxy — это высокопроизводительный прокси-сервер для APT (Advanced Package Tool), написанный на языке Go. Данное ПО позволяет кешировать пакеты и метаданные из репозиториев APT, значительно ускоряя установку и обновление пакетов в системах на базе Debian/Ubuntu.

## Возможности

- Кеширование пакетов и метаданных для ускорения работы APT
- Поддержка нескольких репозиториев одновременно
- Настраиваемые параметры кеширования и TTL валидации
- Эффективное управление кешем по алгоритму LRU (Least Recently Used)
- Поддержка HTTP и Unix socket подключений
- Гибкая настройка через конфигурационный файл
- Подробное логирование и мониторинг

## Установка

### Сборка из исходного кода

```bash
git clone https://github.com/yolkispalkis/go-apt-cache.git
cd go-apt-cache
go build -o go-apt-proxy main.go
```

### Запуск

```bash
./go-apt-proxy -config /path/to/config.json
```

## Конфигурация

Конфигурационный файл представляет собой JSON-документ со следующей структурой:

```json
{
  "server": {
    "listenAddress": ":8080",
    "unixSocketPath": "",
    "unixSocketPermissions": "660",
    "requestTimeout": "60s",
    "shutdownTimeout": "15s",
    "idleTimeout": "120s",
    "readHeaderTimeout": "10s",
    "maxConcurrentFetches": 10
  },
  "cache": {
    "directory": "./cache_data",
    "maxSize": "10GB",
    "enabled": true,
    "cleanOnStart": false,
    "validationTTL": "5m"
  },
  "logging": {
    "level": "info",
    "filePath": "./logs/apt_cache.log",
    "disableTerminal": false,
    "maxSizeMB": 100,
    "maxBackups": 3,
    "maxAgeDays": 7,
    "compress": true
  },
  "repositories": [
    {
      "name": "ubuntu",
      "url": "http://archive.ubuntu.com/ubuntu",
      "enabled": true
    },
    {
      "name": "debian",
      "url": "http://deb.debian.org/debian",
      "enabled": false
    }
  ]
}
```

### Параметры конфигурации

#### Server

- **listenAddress**: Адрес и порт для прослушивания HTTP-запросов (например, ":8080")
- **unixSocketPath**: Путь к Unix сокету (если используется)
- **unixSocketPermissions**: Права доступа для Unix сокета в восьмеричном формате
- **requestTimeout**: Таймаут для HTTP-запросов
- **shutdownTimeout**: Таймаут для корректного завершения работы сервера
- **idleTimeout**: Таймаут для незанятых соединений
- **readHeaderTimeout**: Таймаут для чтения HTTP-заголовков
- **maxConcurrentFetches**: Максимальное количество одновременных запросов к upstream-серверам

#### Cache

- **directory**: Директория для хранения кеша
- **maxSize**: Максимальный размер кеша (например, "10GB")
- **enabled**: Включение/отключение кеширования
- **cleanOnStart**: Очистка кеша при запуске
- **validationTTL**: Время жизни валидации кеша

#### Logging

- **level**: Уровень логирования (debug, info, warn, error)
- **filePath**: Путь к файлу лога
- **disableTerminal**: Отключение вывода логов в терминал
- **maxSizeMB**: Максимальный размер лог-файла в МБ
- **maxBackups**: Максимальное количество файлов ротации логов
- **maxAgeDays**: Максимальный срок хранения лог-файлов в днях
- **compress**: Сжатие архивных лог-файлов

#### Repositories

- **name**: Имя репозитория (будет использоваться в пути URL)
- **url**: URL источника репозитория
- **enabled**: Включение/отключение репозитория

## Параметры командной строки

- **-config**: Путь к конфигурационному файлу (по умолчанию "config.json")
- **-create-config**: Создание конфигурационного файла по умолчанию, если он не существует
- **-listen**: Адрес для прослушивания (переопределяет значение из конфигурационного файла)
- **-unix-socket**: Путь к Unix сокету (переопределяет значение из конфигурационного файла)
- **-cache-dir**: Директория кеша (переопределяет значение из конфигурационного файла)
- **-cache-size**: Максимальный размер кеша (переопределяет значение из конфигурационного файла)
- **-log-level**: Уровень логирования (переопределяет значение из конфигурационного файла)

## Использование с APT

Чтобы настроить APT на использование прокси, создайте файл в директории `/etc/apt/apt.conf.d/` (например, `/etc/apt/apt.conf.d/01proxy`):

```
Acquire::http::Proxy "http://localhost:8080";
```

Или для использования Unix сокета:

```
Acquire::http::Proxy "http://unix:/path/to/socket";
```

## Мониторинг

Сервер предоставляет точку доступа `/status` для проверки состояния:

```bash
curl http://localhost:8080/status
```

Ответ включает в себя информацию о состоянии сервера и кеша:

```
OK
Cache Items: 123
Cache Size: 2.5GB / 10GB
```

## Принцип работы

1. При получении запроса от клиента сервер проверяет наличие запрашиваемого файла в кеше.
2. Если файл найден в кеше и валиден, он возвращается клиенту без обращения к исходному репозиторию.
3. Если файл не найден в кеше или устарел, сервер запрашивает его из исходного репозитория.
4. При получении файла из исходного репозитория, сервер одновременно отправляет файл клиенту и сохраняет его в кеше.
5. Для управления размером кеша используется алгоритм LRU, который удаляет наименее недавно использованные файлы при превышении максимального размера кеша.

## Архитектура

### Основные компоненты

- **Server**: Обрабатывает HTTP-запросы, маршрутизирует их к соответствующим обработчикам репозиториев
- **Cache Manager**: Управляет кешированием файлов на диске, реализует LRU-алгоритм для эффективного использования дискового пространства
- **Fetch Coordinator**: Координирует запросы к upstream-серверам, ограничивая количество одновременных запросов
- **Config**: Управляет загрузкой и валидацией конфигурации
- **Logging**: Обеспечивает настраиваемое логирование с возможностью ротации файлов

## Лицензия

[MIT License](LICENSE) 